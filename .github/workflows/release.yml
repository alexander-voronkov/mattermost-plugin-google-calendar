name: Release & Deploy

on:
  workflow_run:
    workflows: ["CI"]
    types:
      - completed
    branches:
      - main
      - master
  workflow_dispatch:

jobs:
  build-and-release:
    runs-on: ubuntu-22.04
    if: ${{ github.event.workflow_run.conclusion == 'success' || github.event_name == 'workflow_dispatch' }}
    permissions:
      contents: write
    
    steps:
    - name: Checkout
      uses: actions/checkout@v4
    
    - name: Extract version from plugin.json
      id: version
      run: |
        VERSION=$(jq -r '.version' plugin.json)
        PLUGIN_ID=$(jq -r '.id' plugin.json)
        echo "version=$VERSION" >> $GITHUB_OUTPUT
        echo "plugin_id=$PLUGIN_ID" >> $GITHUB_OUTPUT
        echo "tag=v$VERSION" >> $GITHUB_OUTPUT
        echo "Extracted version: $VERSION, plugin_id: $PLUGIN_ID"
    
    - name: Set up Go
      uses: actions/setup-go@v5
      with:
        go-version-file: go.mod
    
    - name: Setup Node
      uses: actions/setup-node@v4
      with:
        node-version-file: .nvmrc
    
    - name: Generate manifest files
      run: |
        mkdir -p build/bin
        cd build/manifest && go build -o ../../build/bin/manifest .
        cd ../..
        ./build/bin/manifest apply
    
    - name: Install webapp dependencies
      run: cd webapp && npm ci
    
    - name: Build webapp
      run: cd webapp && npm run build
    
    - name: Build server (all platforms)
      run: |
        mkdir -p server/dist
        cd server
        CGO_ENABLED=0 GOOS=linux GOARCH=amd64 go build -trimpath -o dist/plugin-linux-amd64 .
        CGO_ENABLED=0 GOOS=linux GOARCH=arm64 go build -trimpath -o dist/plugin-linux-arm64 .
        CGO_ENABLED=0 GOOS=darwin GOARCH=amd64 go build -trimpath -o dist/plugin-darwin-amd64 .
        CGO_ENABLED=0 GOOS=darwin GOARCH=arm64 go build -trimpath -o dist/plugin-darwin-arm64 .
        CGO_ENABLED=0 GOOS=windows GOARCH=amd64 go build -trimpath -o dist/plugin-windows-amd64.exe .
    
    - name: Create plugin bundle
      run: |
        PLUGIN_ID=${{ steps.version.outputs.plugin_id }}
        VERSION=${{ steps.version.outputs.version }}
        
        mkdir -p dist/${PLUGIN_ID}/server/dist dist/${PLUGIN_ID}/webapp/dist dist/${PLUGIN_ID}/assets
        cp plugin.json dist/${PLUGIN_ID}/
        cp server/dist/* dist/${PLUGIN_ID}/server/dist/
        cp webapp/dist/main.js dist/${PLUGIN_ID}/webapp/dist/
        cp -r assets/* dist/${PLUGIN_ID}/assets/
        
        cd dist && tar -czf ${PLUGIN_ID}-${VERSION}.tar.gz ${PLUGIN_ID}
        echo "Bundle created: ${PLUGIN_ID}-${VERSION}.tar.gz"
    
    - name: Check if release exists
      id: check_release
      run: |
        if gh release view ${{ steps.version.outputs.tag }} > /dev/null 2>&1; then
          echo "exists=true" >> $GITHUB_OUTPUT
        else
          echo "exists=false" >> $GITHUB_OUTPUT
        fi
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
    
    - name: Create Git Tag
      if: steps.check_release.outputs.exists == 'false'
      run: |
        git config user.name "github-actions[bot]"
        git config user.email "github-actions[bot]@users.noreply.github.com"
        git tag -a ${{ steps.version.outputs.tag }} -m "Release ${{ steps.version.outputs.tag }}"
        git push origin ${{ steps.version.outputs.tag }}
    
    - name: Create GitHub Release
      if: steps.check_release.outputs.exists == 'false'
      run: |
        gh release create ${{ steps.version.outputs.tag }} \
          --title "Release ${{ steps.version.outputs.version }}" \
          --notes "Automated release build for version ${{ steps.version.outputs.version }}" \
          dist/${{ steps.version.outputs.plugin_id }}-${{ steps.version.outputs.version }}.tar.gz
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
    
    - name: Update existing release
      if: steps.check_release.outputs.exists == 'true'
      run: |
        BUNDLE="${{ steps.version.outputs.plugin_id }}-${{ steps.version.outputs.version }}.tar.gz"
        gh release delete-asset ${{ steps.version.outputs.tag }} $BUNDLE --yes || true
        gh release upload ${{ steps.version.outputs.tag }} dist/$BUNDLE --clobber
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
    
    - name: Upload artifact for deploy job
      uses: actions/upload-artifact@v4
      with:
        name: plugin-bundle
        path: dist/${{ steps.version.outputs.plugin_id }}-${{ steps.version.outputs.version }}.tar.gz

  deploy-to-mattermost:
    needs: build-and-release
    runs-on: ubuntu-22.04
    if: success()

    steps:
    - name: Checkout
      uses: actions/checkout@v4

    - name: Extract version from plugin.json
      id: version
      run: |
        VERSION=$(jq -r '.version' plugin.json)
        PLUGIN_ID=$(jq -r '.id' plugin.json)
        echo "version=$VERSION" >> $GITHUB_OUTPUT
        echo "plugin_id=$PLUGIN_ID" >> $GITHUB_OUTPUT

    - name: Download plugin artifact
      uses: actions/download-artifact@v4
      with:
        name: plugin-bundle

    - name: Disable plugin on Mattermost server
      continue-on-error: true
      run: |
        curl -f -X POST "${{ secrets.MM_URL }}/api/v4/plugins/${{ steps.version.outputs.plugin_id }}/disable" \
          -H "Authorization: Bearer ${{ secrets.MM_ACCESS_TOKEN }}" \
          -H "Content-Type: application/json" || echo "Plugin not found or already disabled"

    - name: Upload plugin to Mattermost server
      run: |
        curl -f -X POST "${{ secrets.MM_URL }}/api/v4/plugins" \
          -H "Authorization: Bearer ${{ secrets.MM_ACCESS_TOKEN }}" \
          -F "plugin=@${{ steps.version.outputs.plugin_id }}-${{ steps.version.outputs.version }}.tar.gz" \
          -F "force=true"

    - name: Enable plugin on Mattermost server
      run: |
        curl -f -X POST "${{ secrets.MM_URL }}/api/v4/plugins/${{ steps.version.outputs.plugin_id }}/enable" \
          -H "Authorization: Bearer ${{ secrets.MM_ACCESS_TOKEN }}" \
          -H "Content-Type: application/json"

    - name: Deployment Summary
      run: |
        echo "## Plugin Deployed! ðŸŽ‰" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "- **Version:** ${{ steps.version.outputs.version }}" >> $GITHUB_STEP_SUMMARY
        echo "- **Plugin ID:** ${{ steps.version.outputs.plugin_id }}" >> $GITHUB_STEP_SUMMARY
        echo "- **Server:** ${{ secrets.MM_URL }}" >> $GITHUB_STEP_SUMMARY
